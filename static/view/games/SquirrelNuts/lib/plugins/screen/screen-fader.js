ig.module("plugins.screen.screen-fader").requires("impact.timer","impact.animation").defines(function(){ig.ScreenFader=ig.Class.extend({defaultOptions:{color:{r:0,g:0,b:0,a:1},fade:"in",speed:1,screenWidth:0,screenHeight:0,waitUntilLoaded:!0,visible:!0},init:function(i){this._setOptions(i);var t="out"!=this.options.fade;if(this._alpha=t?0:1,this._alphaChange=t?1:-1,this.options.tileImagePath){if(isNaN(this.options.tileWidth))throw new Error("ScreenFader option for tileWidth is invalid");if(isNaN(this.options.tileHeight))throw new Error("ScreenFader option for tileHeight is invalid");this._sheet=new ig.AnimationSheet(this.options.tileImagePath,this.options.tileWidth,this.options.tileHeight),this._anim=new ig.Animation(this._sheet,1,[0]),this._anim.alpha=this._alpha}if(!isNaN(this.options.delayBefore)){var e=this.options.delayBefore<=0?0:this.options.delayBefore;e>0&&(this.timerDelayBefore=new ig.Timer(e))}},draw:function(){if(this.timerDelayAfter&&this.timerDelayAfter.delta()>0&&(delete this.timerDelayAfter,this._callUserCallback()),this.timerDelayBefore){if(this.timerDelayBefore.delta()<0)return;delete this.timerDelayBefore}this.options.visible&&(this.isFinished||this._sheet&&!this._sheet.image.loaded&&this.options.waitUntilLoaded||this._fadeAlphaValue(),this._alpha<=0||(this._anim?this.drawImageTiledOnScreen():this.drawColorOnScreen()))},drawImageTiledOnScreen:function(){for(var i=0,t=0,e=this.options.screenWidth,s=this.options.screenHeight,a=this.options.tileWidth,h=this.options.tileHeight;t<s;){for(i=0;i<e;)this._anim.draw(i,t),i+=a;t+=h}},drawColorOnScreen:function(){ig.system.clear(this.getColorCssValue())},getColorCssValue:function(i){var t=i||this.options.color,e=(void 0!==t.a?t.a:1)*this._alpha;return e<0?e=0:e>1&&(e=1),"rgba("+t.r+","+t.g+","+t.b+","+e+")"},finish:function(){if(!this.isFinished&&(this._alphaChange>0?this._alpha=1:this._alpha=0,this._anim&&(this._anim.alpha=this._alpha),this.isFinished=!0,"function"==typeof this.options.callback)){var i=isNaN(this.options.delayAfter)?0:this.options.delayAfter;i>0?this.timerDelayAfter=new ig.Timer(i):this._callUserCallback()}},_callUserCallback:function(){this.options.callback.call(this.options.context||(ig.ScreenFader.globalGameIsContext?ig.game:this))},_fadeAlphaValue:function(){this._alpha+=this._alphaChange*this.options.speed*ig.system.tick*ig.ScreenFader.globalSpeedFactor,(this._alphaChange>0&&this._alpha>=1||this._alphaChange<0&&this._alpha<=0)&&this.finish(),this._anim&&(this._anim.alpha=this._alpha)},_setOptions:function(i){this.options=ig.copy(this.defaultOptions),(isNaN(this.options.screenWidth)||this.options.screenWidth<=0)&&(this.options.screenWidth=ig.system.width),(isNaN(this.options.screenHeight)||this.options.screenHeight<=0)&&(this.options.screenHeight=ig.system.height),i&&ig.merge(this.options,i)}}),ig.ScreenFader.globalSpeedFactor=2/3,ig.ScreenFader.globalGameIsContext=!0});