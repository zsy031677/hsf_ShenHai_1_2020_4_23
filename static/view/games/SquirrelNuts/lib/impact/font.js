ig.module("impact.font").requires("impact.image").defines(function(){"use strict";ig.Font=ig.Image.extend({widthMap:[],indices:[],firstChar:32,alpha:1,letterSpacing:1,lineSpacing:0,onload:function(t){this._loadMetrics(this.data),this.parent(t)},widthForString:function(t){if(-1!==t.indexOf("\n")){for(var i=t.split("\n"),h=0,e=0;e<i.length;e++)h=Math.max(h,this._widthForLine(i[e]));return h}return this._widthForLine(t)},_widthForLine:function(t){for(var i=0,h=0;h<t.length;h++)i+=this.widthMap[t.charCodeAt(h)-this.firstChar]+this.letterSpacing;return i},heightForString:function(t){return t.split("\n").length*(this.height+this.lineSpacing)},draw:function(t,i,h,e){if("string"!=typeof t&&(t=t.toString()),-1===t.indexOf("\n")){if(e==ig.Font.ALIGN.RIGHT||e==ig.Font.ALIGN.CENTER){var s=this._widthForLine(t);i-=e==ig.Font.ALIGN.CENTER?s/2:s}1!==this.alpha&&(ig.system.context.globalAlpha=this.alpha);for(g=0;g<t.length;g++){var n=t.charCodeAt(g);i+=this._drawChar(n-this.firstChar,i,h)}1!==this.alpha&&(ig.system.context.globalAlpha=1),ig.Image.drawCount+=t.length}else for(var a=t.split("\n"),r=this.height+this.lineSpacing,g=0;g<a.length;g++)this.draw(a[g],i,h+g*r,e)},_drawChar:function(t,i,h){if(!this.loaded||t<0||t>=this.indices.length)return 0;var e=ig.system.scale,s=this.indices[t]*e,n=this.widthMap[t]*e,a=(this.height-2)*e;return ig.system.context.drawImage(this.data,s,0,n,a,ig.system.getDrawPos(i),ig.system.getDrawPos(h),n,a),this.widthMap[t]+this.letterSpacing},_loadMetrics:function(t){this.height=t.height-1,this.widthMap=[],this.indices=[];for(var i=ig.getImagePixels(t,0,t.height-1,t.width,1),h=0,e=0;e<t.width;e++){var s=4*e+3;i.data[s]>127?h++:i.data[s]<128&&h&&(this.widthMap.push(h),this.indices.push(e-h),0,h=0)}this.widthMap.push(h),this.indices.push(e-h)}}),ig.Font.ALIGN={LEFT:0,RIGHT:1,CENTER:2}});