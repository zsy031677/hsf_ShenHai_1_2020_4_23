ig.module("impact.image").defines(function(){"use strict";ig.Image=ig.Class.extend({data:null,width:0,height:0,loaded:!1,failed:!1,loadCallback:null,path:"",staticInstantiate:function(t){return ig.Image.cache[t]||null},init:function(t){this.path=t,this.load()},load:function(t){this.loaded?t&&t(this.path,!0):(!this.loaded&&ig.ready?(this.loadCallback=t||null,this.data=new Image,this.data.onload=this.onload.bind(this),this.data.onerror=this.onerror.bind(this),this.data.src=ig.prefix+this.path+ig.nocache):ig.addResource(this),ig.Image.cache[this.path]=this)},reload:function(){this.loaded=!1,this.data=new Image,this.data.onload=this.onload.bind(this),this.data.src=this.path+"?"+Date.now()},onload:function(t){this.width=this.data.width,this.height=this.data.height,this.loaded=!0,1!=ig.system.scale&&this.resize(ig.system.scale),this.loadCallback&&this.loadCallback(this.path,!0)},onerror:function(t){this.failed=!0,this.loadCallback&&this.loadCallback(this.path,!1)},resize:function(t){var a=ig.getImagePixels(this.data,0,0,this.width,this.height),i=this.width*t,s=this.height*t,e=ig.$new("canvas");e.width=i,e.height=s;for(var h=e.getContext("2d"),d=h.getImageData(0,0,i,s),o=0;o<s;o++)for(var g=0;g<i;g++){var l=4*(Math.floor(o/t)*this.width+Math.floor(g/t)),n=4*(o*i+g);d.data[n]=a.data[l],d.data[n+1]=a.data[l+1],d.data[n+2]=a.data[l+2],d.data[n+3]=a.data[l+3]}h.putImageData(d,0,0),this.data=e},draw:function(t,a,i,s,e,h){if(this.loaded){var d=ig.system.scale;i=i?i*d:0,s=s?s*d:0,e=(e||this.width)*d,h=(h||this.height)*d,ig.system.context.drawImage(this.data,i,s,e,h,ig.system.getDrawPos(t),ig.system.getDrawPos(a),e,h),ig.Image.drawCount++}},drawTile:function(t,a,i,s,e,h,d){if(e=e||s,!(!this.loaded||s>this.width||e>this.height)){var o=ig.system.scale,g=Math.floor(s*o),l=Math.floor(e*o),n=h?-1:1,r=d?-1:1;(h||d)&&(ig.system.context.save(),ig.system.context.scale(n,r)),ig.system.context.drawImage(this.data,Math.floor(i*s)%this.width*o,Math.floor(i*s/this.width)*e*o,g,l,ig.system.getDrawPos(t)*n-(h?g:0),ig.system.getDrawPos(a)*r-(d?l:0),g,l),(h||d)&&ig.system.context.restore(),ig.Image.drawCount++}}}),ig.Image.drawCount=0,ig.Image.cache={},ig.Image.reloadCache=function(){for(var t in ig.Image.cache)ig.Image.cache[t].reload()}});