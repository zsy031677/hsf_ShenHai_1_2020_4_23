ig.module("impact.sound").defines(function(){"use strict";ig.SoundManager=ig.Class.extend({clips:{},volume:1,format:null,init:function(){if(ig.Sound.enabled&&window.Audio){for(var t=new Audio,e=0;e<ig.Sound.use.length;e++){var i=ig.Sound.use[e];if(t.canPlayType(i.mime)){this.format=i;break}}this.format||(ig.Sound.enabled=!1)}else ig.Sound.enabled=!1},load:function(t,e,i){var n=ig.prefix+t.replace(/[^\.]+$/,this.format.ext)+ig.nocache;if(this.clips[t]){if(e&&this.clips[t].length<ig.Sound.channels)for(r=this.clips[t].length;r<ig.Sound.channels;r++){(a=new Audio(n)).load(),this.clips[t].push(a)}return this.clips[t][0]}var s=new Audio(n);if(i&&(s.addEventListener("canplaythrough",function e(n){s.removeEventListener("canplaythrough",e,!1),i(t,!0,n)},!1),s.addEventListener("error",function(e){i(t,!1,e)},!1)),s.preload="auto",s.load(),this.clips[t]=[s],e)for(var r=1;r<ig.Sound.channels;r++){var a=new Audio(n);a.load(),this.clips[t].push(a)}return s},get:function(t){for(var e,i=this.clips[t],n=0;e=i[n++];)if(e.paused||e.ended)return e.ended&&(e.currentTime=0),e;return i[0].pause(),i[0].currentTime=0,i[0]}}),ig.Music=ig.Class.extend({tracks:[],namedTracks:{},currentTrack:null,currentIndex:0,random:!1,_volume:1,_loop:!1,_fadeInterval:0,_fadeTimer:null,_endedCallbackBound:null,init:function(){this._endedCallbackBound=this._endedCallback.bind(this),Object.defineProperty?(Object.defineProperty(this,"volume",{get:this.getVolume.bind(this),set:this.setVolume.bind(this)}),Object.defineProperty(this,"loop",{get:this.getLooping.bind(this),set:this.setLooping.bind(this)})):this.__defineGetter__&&(this.__defineGetter__("volume",this.getVolume.bind(this)),this.__defineSetter__("volume",this.setVolume.bind(this)),this.__defineGetter__("loop",this.getLooping.bind(this)),this.__defineSetter__("loop",this.setLooping.bind(this)))},add:function(t,e){if(ig.Sound.enabled){var i=t instanceof ig.Sound?t.path:t,n=ig.soundManager.load(i,!1);n.loop=this._loop,n.volume=this._volume,n.addEventListener("ended",this._endedCallbackBound,!1),this.tracks.push(n),e&&(this.namedTracks[e]=n),this.currentTrack||(this.currentTrack=n)}},next:function(){this.tracks.length&&(this.stop(),this.currentIndex=this.random?Math.floor(Math.random()*this.tracks.length):(this.currentIndex+1)%this.tracks.length,this.currentTrack=this.tracks[this.currentIndex],this.play())},pause:function(){this.currentTrack&&this.currentTrack.pause()},stop:function(){this.currentTrack&&(this.currentTrack.pause(),this.currentTrack.currentTime=0)},play:function(t){if(t&&this.namedTracks[t]){var e=this.namedTracks[t];e!=this.currentTrack&&(this.stop(),this.currentTrack=e)}else if(!this.currentTrack)return;this.currentTrack.play()},getLooping:function(){return this._loop},setLooping:function(t){this._loop=t;for(var e in this.tracks)this.tracks[e].loop=t},getVolume:function(){return this._volume},setVolume:function(t){this._volume=t.limit(0,1);for(var e in this.tracks)this.tracks[e].volume=this._volume},fadeOut:function(t){this.currentTrack&&(clearInterval(this._fadeInterval),this.fadeTimer=new ig.Timer(t),this._fadeInterval=setInterval(this._fadeStep.bind(this),50))},_fadeStep:function(){var t=this.fadeTimer.delta().map(-this.fadeTimer.target,0,1,0).limit(0,1)*this._volume;t<=.01?(this.stop(),this.currentTrack.volume=this._volume,clearInterval(this._fadeInterval)):this.currentTrack.volume=t},_endedCallback:function(){this._loop?this.play():this.next()}}),ig.Sound=ig.Class.extend({path:"",volume:1,currentClip:null,multiChannel:!0,init:function(t,e){this.path=t,this.multiChannel=!1!==e,this.load()},load:function(t){ig.Sound.enabled?ig.ready?ig.soundManager.load(this.path,this.multiChannel,t):ig.addResource(this):t&&t(this.path,!0)},play:function(){ig.Sound.enabled&&(this.currentClip=ig.soundManager.get(this.path),this.currentClip.volume=ig.soundManager.volume*this.volume,this.currentClip.play())},stop:function(){this.currentClip&&(this.currentClip.pause(),this.currentClip.currentTime=0)}}),ig.Sound.FORMAT={MP3:{ext:"mp3",mime:"audio/mpeg"},M4A:{ext:"m4a",mime:"audio/mp4; codecs=mp4a"},OGG:{ext:"ogg",mime:"audio/ogg; codecs=vorbis"},WEBM:{ext:"webm",mime:"audio/webm; codecs=vorbis"},CAF:{ext:"caf",mime:"audio/x-caf"}},ig.Sound.use=[ig.Sound.FORMAT.OGG,ig.Sound.FORMAT.MP3],ig.Sound.channels=4,ig.Sound.enabled=!0});