ig.module("impact.background-map").requires("impact.map","impact.image").defines(function(){"use strict";ig.BackgroundMap=ig.Map.extend({tiles:null,scroll:{x:0,y:0},distance:1,repeat:!1,tilesetName:"",foreground:!1,enabled:!0,preRender:!1,preRenderedChunks:null,chunkSize:512,debugChunks:!1,anims:{},init:function(i,e,t){this.parent(i,e),this.setTileset(t)},setTileset:function(i){this.tilesetName=i instanceof ig.Image?i.path:i,this.tiles=new ig.Image(this.tilesetName),this.preRenderedChunks=null},setScreenPos:function(i,e){this.scroll.x=i/this.distance,this.scroll.y=e/this.distance},preRenderMapToChunks:function(){var i=this.width*this.tilesize*ig.system.scale,e=this.height*this.tilesize*ig.system.scale;this.chunkSize=Math.min(Math.max(i,e),this.chunkSize);var t=Math.ceil(i/this.chunkSize),s=Math.ceil(e/this.chunkSize);this.preRenderedChunks=[];for(var h=0;h<s;h++){this.preRenderedChunks[h]=[];for(var n=0;n<t;n++){var r=n==t-1?i-n*this.chunkSize:this.chunkSize,a=h==s-1?e-h*this.chunkSize:this.chunkSize;this.preRenderedChunks[h][n]=this.preRenderChunk(n,h,r,a)}}},preRenderChunk:function(i,e,t,s){var h=t/this.tilesize/ig.system.scale+1,n=s/this.tilesize/ig.system.scale+1,r=i*this.chunkSize/ig.system.scale%this.tilesize,a=e*this.chunkSize/ig.system.scale%this.tilesize,l=Math.floor(i*this.chunkSize/this.tilesize/ig.system.scale),c=Math.floor(e*this.chunkSize/this.tilesize/ig.system.scale),d=ig.$new("canvas");d.width=t,d.height=s,d.retinaResolutionEnabled=!1;var u=d.getContext("2d");ig.System.scaleMode(d,u);var o=ig.system.context;ig.system.context=u;for(var g=0;g<h;g++)for(var z=0;z<n;z++)if(g+l<this.width&&z+c<this.height){var m=this.data[z+c][g+l];m&&this.tiles.drawTile(g*this.tilesize-r,z*this.tilesize-a,m-1,this.tilesize)}return ig.system.context=o,d},draw:function(){this.tiles.loaded&&this.enabled&&(this.preRender?this.drawPreRendered():this.drawTiled())},drawPreRendered:function(){this.preRenderedChunks||this.preRenderMapToChunks();var i=ig.system.getDrawPos(this.scroll.x),e=ig.system.getDrawPos(this.scroll.y);if(this.repeat){var t=this.width*this.tilesize*ig.system.scale;i=(i%t+t)%t;var s=this.height*this.tilesize*ig.system.scale;e=(e%s+s)%s}var h=Math.max(Math.floor(i/this.chunkSize),0),n=Math.max(Math.floor(e/this.chunkSize),0),r=Math.ceil((i+ig.system.realWidth)/this.chunkSize),a=Math.ceil((e+ig.system.realHeight)/this.chunkSize),l=this.preRenderedChunks[0].length,c=this.preRenderedChunks.length;this.repeat||(r=Math.min(r,l),a=Math.min(a,c));for(var d=0,u=n;u<a;u++){for(var o=0,g=h;g<r;g++){var z=this.preRenderedChunks[u%c][g%l],m=-i+g*this.chunkSize-o,k=-e+u*this.chunkSize-d;ig.system.context.drawImage(z,m,k),ig.Image.drawCount++,this.debugChunks&&(ig.system.context.strokeStyle="#f0f",ig.system.context.strokeRect(m,k,this.chunkSize,this.chunkSize)),this.repeat&&z.width<this.chunkSize&&m+z.width<ig.system.realWidth&&(o+=this.chunkSize-z.width,r++)}this.repeat&&z.height<this.chunkSize&&k+z.height<ig.system.realHeight&&(d+=this.chunkSize-z.height,a++)}},drawTiled:function(){for(var i=0,e=null,t=(this.scroll.x/this.tilesize).toInt(),s=(this.scroll.y/this.tilesize).toInt(),h=this.scroll.x%this.tilesize,n=this.scroll.y%this.tilesize,r=-h-this.tilesize,a=-n-this.tilesize,l=ig.system.width+this.tilesize-h,c=ig.system.height+this.tilesize-n,d=-1,u=a;u<c;d++,u+=this.tilesize){var o=d+s;if(o>=this.height||o<0){if(!this.repeat)continue;o=(o%this.height+this.height)%this.height}for(var g=-1,z=r;z<l;g++,z+=this.tilesize){var m=g+t;if(m>=this.width||m<0){if(!this.repeat)continue;m=(m%this.width+this.width)%this.width}(i=this.data[o][m])&&((e=this.anims[i-1])?e.draw(z,u):this.tiles.drawTile(z,u,i-1,this.tilesize))}}}})});