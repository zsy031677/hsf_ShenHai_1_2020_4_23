function CGame(e){var t,n,i,o,s,a,r,l,_,c,u,d,T,h,S,A=null,E=!1,L=!1,I=!1,p=null;this._init=function(){$(s_oMain).trigger("start_session"),$(s_oMain).trigger("start_level",1),r=0,l=NUM_OF_BALLS-1,_=MIN_BALL_TIME_TO_STOP,c=TIME_RESET_AFTER_GOAL,s=new createjs.Container,s_oStage.addChild(s),(n=createBitmap(s_oSpriteLibrary.getSprite("bg_game"))).cache(0,0,CANVAS_WIDTH,CANVAS_HEIGHT),s.addChild(n),a=new CAnimationBallTub(s),i=new CScenario(1),p=SHOW_3D_RENDER?camera:createPerspectiveGraphicCamera(),resizeCanvas3D(),setVolume("soundtrack",.3),S=new CController,(t=new CInterface).refreshTextScoreBoard("",null,null),u=new CANNON.Vec3(0,0,0),new CHelpPanel(s_oSpriteLibrary.getSprite("msg_box")),T=new CLoadingPanel},this.scenarioLoaded=function(){d=STATE_INIT,(o=new CBall(0,0,i.ballBody(),s)).setVisible(!1),i.ballBody().sleep(),o.setCurBallSpriteIndex(a.getCurBallSprite()),this._updateBall2DPosition();var e=this.convert3dPosTo2dScreen(i.ballBody().position,p),t={x:i.ballBody().position.x+BALL_RADIUS,y:i.ballBody().position.y,z:i.ballBody().position.z},n=this.convert3dPosTo2dScreen(t,p);BALL_SCALE_REFERENCE=n.x-e.x,h=new createjs.Container,s.addChild(h),new COcclusionController(s_oScenario.getWorld(),s_oScenario.ballBody(),h),setTimeout(function(){T.unload()},500+1e3*Math.random())},this.createControl=function(){SHOW_3D_RENDER&&window.addEventListener("mousedown",this.onMouseDown)},this.sortDepth=function(e,t){e.getDepthPos()>t.getDepthPos()?s.getChildIndex(e.getObject())>s.getChildIndex(t.getObject())&&s.swapChildren(e.getObject(),t.getObject()):e.getDepthPos()<t.getDepthPos()&&s.getChildIndex(t.getObject())>s.getChildIndex(e.getObject())&&s.swapChildren(t.getObject(),e.getObject())},this.onExitHelp=function(){this.createControl();playSound("start_game",1,!1).once("end",function(){s_oGame.endStartAnim()}),a.playStartAnim(),t.unlitLaunchBoard(),t.playStartAnim()},this.endStartAnim=function(){d=STATE_INIT,o.setVisible(!0),setVolume("ambience",0),playSound("soundtrack",1,!0),t.refreshLaunchBoard(l),S.enable()},this.fieldCollision=function(){null===A&&L&&null!==A&&A.on("end",function(){A=null})},this.ballPosition=function(){var e=i.ballBody();if(void 0!==e){var t=this.convert3dPosTo2dScreen(e.position,p),n={x:e.position.x+BALL_RADIUS,y:e.position.y,z:e.position.z},s=(this.convert3dPosTo2dScreen(n,p).x-t.x)/BALL_SCALE_REFERENCE;o.setPosition(t.x,t.y),o.scale(s),o.rolls(),L&&e.velocity.length()<MIN_BALL_SPEED_TO_STOP?(_-=s_iTimeElaps)<0&&(_=MIN_BALL_TIME_TO_STOP,this.endTurn()):_=MIN_BALL_TIME_TO_STOP}},this.setBallPosition=function(e){var t,n=i.ballBody().position.x;t="right"===e?n+10:n-10,Math.abs(t)>MAX_BALL_DRAG_LIMITS&&(t=t<0?-MAX_BALL_DRAG_LIMITS:MAX_BALL_DRAG_LIMITS),i.ballBody().position.set(t,i.ballBody().position.y,i.ballBody().position.z)},this.onMouseDown=function(e){},this.launchBall=function(e,t){var n=e*(MAX_STRENGTH_Y-MIN_STRENGTH_Y)+MIN_STRENGTH_Y,i=MAX_STRENGTH_X*(t/MAX_ARROW_ANGLE);u.set(i,n,0),s_oGame.addImpulseToBall(u)},this.getHitDirection=function(){return u},this.goal=function(e){E||(E=!0,this.setScore(HOLE_SCORE[e]))},this.getCurScore=function(){return r},this.setScore=function(e){r+=e;var n=null,i=null;switch(e){case HOLE_SCORE[30]:n=TEXT_CONGRATULATION[0],i=LIT_ANIMATION_30,playSound("sound_30_40",1,!1);break;case HOLE_SCORE[40]:n=TEXT_CONGRATULATION[1],i=LIT_ANIMATION_40,playSound("sound_30_40",1,!1);break;case HOLE_SCORE[50]:n=TEXT_CONGRATULATION[2],i=LIT_ANIMATION_50,playSound("sound_50_100",1,!1);break;case HOLE_SCORE["100_a"]:case HOLE_SCORE["100_a"]:n=TEXT_CONGRATULATION[3],i=LIT_ANIMATION_100,playSound("sound_50_100",1,!1);break;default:i=LIT_ANIMATION_10,playSound("sound_10_20",1,!1)}t.refreshTextScoreBoard(r,n,i)},this.unload=function(){s_oStage.removeAllChildren(),t.unload(),i.destroyWorld(),i=null},this.resetValues=function(){r=0,t.refreshTextScoreBoard(0,null,null),l=NUM_OF_BALLS-1,t.refreshLaunchBoard(l,NUM_OF_BALLS),S.disable()},this.addImpulseToBall=function(e){if(!L&&d===STATE_PLAY){var t=i.ballBody();t.wakeUp(),i.addImpulse(t,e),L=!0,o.setVisible(!0),playSound("shot",1,!1)}},this.pause=function(e){trace("PAUSE"),d=e?STATE_PAUSE:STATE_PLAY,createjs.Ticker.paused=e},this.onExit=function(){this.unload(),$(s_oMain).trigger("show_interlevel_ad"),$(s_oMain).trigger("end_session"),setVolume("ambience",1),stopSound("soundtrack"),s_oMain.gotoMenu()},this.restartLevel=function(){this.resetValues(),this.resetScene(),d=STATE_PLAY,$(s_oMain).trigger("restart_level",1)},this.resetBallPosition=function(){var e=i.ballBody();e.force.setZero(),e.torque.setZero(),e.angularVelocity.setZero(),e.velocity.setZero(),e.quaternion.set(0,0,0,1),e.inertia.setZero(),e.position.set(POSITION_BALL.x,POSITION_BALL.y,POSITION_BALL.z),e.sleep(),o.fadeAnimation(1,500,0)},this.ballFadeForReset=function(){I||(I=!0,s_oGame.endTurn())},this._updateInit=function(){i.update(),this._updateBall2DPosition(),d=STATE_PLAY},this.convert2dScreenPosTo3d=function(e){var t=s_iCanvasResizeWidth,n=s_iCanvasResizeHeight,i=new THREE.Vector3(e.x/t*2-1,-e.y/n*2+1,-1);i.unproject(p),i.sub(p.position),i.normalize();return i.multiply(new THREE.Vector3(0,1,0)),i},this.convert3dPosTo2dScreen=function(e,t){var n=new THREE.Vector3(e.x,e.y,e.z).project(t),i=.5*Math.floor(s_iCanvasResizeWidth),o=.5*Math.floor(s_iCanvasResizeHeight);return n.x=(n.x*i+i)*s_fInverseScaling,n.y=(-n.y*o+o)*s_fInverseScaling,n},this.timeReset=function(){c>0?c-=s_iTimeElaps:this.endTurn()},this.restartGame=function(){this.resetValues(),this.resetScene(),S.arrowVisibility(!1),this.onExitHelp()},this.endTurn=function(){--l>=0?(this.resetScene(),L=!1):(l=0,d=STATE_FINISH,r>s_iBestScore&&(s_iBestScore=Math.floor(r),saveItem(LOCALSTORAGE_STRING[LOCAL_BEST_SCORE],Math.floor(r))),t.createWinPanel(Math.floor(r)),$(s_oMain).trigger("end_level",1)),t.refreshLaunchBoard(l,NUM_OF_BALLS)},this.resetScene=function(){E=!1,I=!1,L=!1,c=TIME_RESET_AFTER_GOAL,this.resetBallPosition();var e=a.getNextBall();o.setCurBallSpriteIndex(e),S.resetControls()},this._onEnd=function(){this.onExit()},this.getBallPos=function(){return o.getPosition()},this.getState=function(){return d},this._updatePlay=function(){for(var e=0;e<PHYSICS_ACCURACY;e++)i.update();s_oOcclusionController.checkCollision(),E&&this.timeReset(),this._updateBall2DPosition()},this.update=function(){switch(d){case STATE_INIT:this._updateInit();break;case STATE_PLAY:this._updatePlay();break;case STATE_FINISH:case STATE_PAUSE:}},this._updateBall2DPosition=function(){this.ballPosition(),p.updateProjectionMatrix(),p.updateMatrixWorld()},s_oGame=this,NUM_OF_BALLS=e.num_of_balls,NUM_LEVEL_FOR_ADS=e.num_levels_for_ads,this._init()}var s_oGame;